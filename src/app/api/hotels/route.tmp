import { NextRequest, NextResponse } from "next/server";

type HalalFeatures = {
  halalFood: boolean;
  noAlcohol: boolean;
  prayerRoom: boolean;
  mosqueNearby: boolean;
  genderedPool: boolean;
};

type Hotel = {
  id: string;
  name: string;
  city: string;
  country: string;
  stars?: number;
  priceFrom?: number;
  features: HalalFeatures;
  halalScore: number;        // wordt berekend
  partnerUrl: string;        // hier komt straks je affiliate deeplink
};

function calcHalalScore(f: HalalFeatures) {
  const pts =
    (f.halalFood ? 2 : 0) +
    (f.noAlcohol ? 2 : 0) +
    (f.genderedPool ? 2 : 0) +
    (f.prayerRoom ? 1 : 0) +
    (f.mosqueNearby ? 1 : 0);
  return Math.max(1, Math.min(5, Math.round(pts / 2)));
}

const MOCK: Omit<Hotel, "halalScore">[] = [
  {
    id: "dxb-001",
    name: "Aurora Beach Resort",
    city: "Dubai",
    country: "UAE",
    stars: 5,
    priceFrom: 189,
    features: { halalFood: true, noAlcohol: true, prayerRoom: true, mosqueNearby: true, genderedPool: false },
    partnerUrl: "https://example.com/deeplink?marker=TRIPVIU&hotel=dxb-001",
  },
  {
    id: "ist-002",
    name: "Golden Minaret Hotel",
    city: "Istanbul",
    country: "TÃ¼rkiye",
    stars: 4,
    priceFrom: 120,
    features: { halalFood: true, noAlcohol: false, prayerRoom: true, mosqueNearby: true, genderedPool: false },
    partnerUrl: "https://example.com/deeplink?marker=TRIPVIU&hotel=ist-002",
  },
];

export async function GET(req: NextRequest) {
  const city = req.nextUrl.searchParams.get("city") ?? "";
  const filtered = MOCK
    .filter(h => (city ? h.city.toLowerCase().includes(city.toLowerCase()) : true))
    .map(h => ({ ...h, halalScore: calcHalalScore(h.features) }));

  return NextResponse.json({ city, hotels: filtered });
}